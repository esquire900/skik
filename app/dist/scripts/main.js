"use strict";angular.module("genApp",["ngCookies","ngResource","ngSanitize","ngRoute","ngScrollTo"]).config(function($routeProvider){return $routeProvider.when("/home",{templateUrl:"scripts/comp/home/home.html",controller:"HomeCtrl"}).when("/languages",{templateUrl:"scripts/comp/languages/languages.html",controller:"LanguagesCtrl"}).when("/settings",{templateUrl:"scripts/comp/settings/settings.html",controller:"SettingsCtrl"}).when("/faq",{templateUrl:"scripts/comp/faq/faq.html"}).when("/reset",{templateUrl:"scripts/comp/faq/faq.html",controller:"ResetCtrl"}).otherwise({redirectTo:"/home"})}).service("Initializer",function($q,User){var is_initialized,resolver;return is_initialized=!1,resolver=function(){var deferred;return deferred=new $q.defer,is_initialized===!1?User.getAuthKey().then(function(auth_key){return User.getSettings().then(auth_key===!1?function(settings){return settings===!1?User.getDefaultSettings().then(function(dSettings){return User.setSettings(dSettings).then(function(){return is_initialized=!0,deferred.resolve(!0)})}):(is_initialized=!0,deferred.resolve(!0))}:function(){return is_initialized=!0,deferred.resolve(!0)})}):deferred.resolve(!0),deferred.promise},{init:resolver}}),angular.module("genApp").service("api",function($http,$q){var api;return api={},api.baseUrl="skikapp.com"===document.location.hostname?"http://api.skikapp.com/v1/":"http://localhost/project/wuw/api/web/v1/",api.get=function(url){var data,deferred;return deferred=new $q.defer,"object"==typeof url?(data=url,data.url=api.baseUrl+url.url):(data={},data.url=api.baseUrl+url),data.method="GET",$http(data).then(function(res){return deferred.resolve(res.data)},function(errorCode){return _.isUndefined(errorCode.data.error)?(sweetAlert("This is awkward...","The API seems to be down. Nothing I can do here, sorry","error"),!1):("User couldnt be found."===errorCode.data.error.message&&sweetAlert({title:"This is awkward...",text:"I can't find your authentication key, which probably means something is screwed at le server. Please go here http://skikapp.com/#/reset and login again :)",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",closeOnConfirm:!1}),deferred.reject(errorCode.data.error.message))}),deferred.promise},api.post=function(url){var data,deferred;return deferred=new $q.defer,"object"==typeof url?(data=url,data.url=api.baseUrl+url.url):(data={},data.url=api.baseUrl+url),data.method="POST",$http(data).then(function(res){return deferred.resolve(res.data)},function(errorCode){return _.isUndefined(errorCode.data.error)?(sweetAlert("This is awkward...","The API seems to be down. Nothing I can do here, sorry","error"),!1):("User couldnt be found."===errorCode.data.error.message&&sweetAlert({title:"This is awkward...",text:"I can't find your authentication key, which probably means something is screwed at le server. Please go here http://skikapp.com/#/reset and login again :)",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",closeOnConfirm:!1}),deferred.reject(errorCode.data.error.message))}),deferred.promise},api}),angular.module("genApp").controller("HomeCtrl",function($scope,$http,api,User,Initializer,$sce,$window,ScrollTo){var fetchRepositories,init,prepareNews,_is_initialized,_tmp_repo_rows;return $scope.trees=[],$scope.userIsNew=!1,$scope.settings=!1,$scope.openedArticles={},$scope.userLoggedIn=!1,$scope.loginBtnText="Login",$scope.loginLabelText="register",$scope.lastPage=0,$scope.news=!1,$scope.loginError=!1,$scope.loginErrorStart=!1,$scope.loadingLogin=!1,$scope.rand=Math.floor(7*Math.random()+1),_tmp_repo_rows=!1,_is_initialized=!1,init=function(){return _is_initialized?!0:($scope.loading=!0,Initializer.init().then(function(){return User.getSettings().then(function(settings){return $scope.settings=settings,$scope.feedList=[],$scope.languageNames=[],api.get("languages?with_feeds=true").then(function(allFeeds){var index,l,lang,_i,_j,_len,_len1,_ref,_results;for(_ref=$scope.settings.languages_following,_results=[],index=_i=0,_len=_ref.length;_len>_i;index=++_i){for(lang=_ref[index],_j=0,_len1=allFeeds.length;_len1>_j;_j++)l=allFeeds[_j],l.name.toLowerCase()===lang.toLowerCase()&&($scope.feedList[index]=l.feeds);$scope.languageNames[index]=lang,_results.push($scope.trees[index]=!0)}return _results}),User.getAuthKey().then(function(key){return key===!1&&0===$scope.settings.languages_following.length&&($scope.userIsNew=!0),$scope.userLoggedIn=key===!1?!1:!0,$scope.userIsNew||fetchRepositories(),$scope.loading=!1,$scope.$$phase||$scope.$apply(),_is_initialized=!0})})}))},fetchRepositories=function(newsOnly){return User.getAuthKey().then(function(key){return User.getSettings().then(function(settings){return $scope.settings=settings,0!==settings.languages_following.length?key!==!1?(newsOnly!==!0&&api.get("repos?auth_key="+key).then(function(res){return _tmp_repo_rows=!1,$scope.repos=res,$scope.$$phase?void 0:$scope.$apply()}),api.get("news?auth_key="+key).then(function(res){return prepareNews(res)})):(newsOnly!==!0&&api.post({url:"repos",data:$.param({settings:settings}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(res){return _tmp_repo_rows=!1,$scope.repos=res,$scope.$$phase?void 0:$scope.$apply()}),api.post({url:"news",data:$.param({settings:settings}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(res){return prepareNews(res)})):($scope.notFollowingAnything=!0,$scope.$$phase?void 0:$scope.$apply())})})},prepareNews=function(serverRes){var i,index,n,_i,_j,_len,_len1;for(index=_i=0,_len=serverRes.length;_len>_i;index=++_i)n=serverRes[index],_.isString(serverRes[index].content)&&(serverRes[index].content=$sce.trustAsHtml(n.content),""===n.content&&(serverRes[index].content=$sce.trustAsHtml(n.description)),""===n.content&&(serverRes[index].content=$sce.trustAsHtml("No content in rss feed found"))),serverRes[index].date=moment(n.date,"X").fromNow();if($scope.news===!1)$scope.news=serverRes;else for(_j=0,_len1=serverRes.length;_len1>_j;_j++)i=serverRes[_j],$scope.news.push(i);return $scope.$$phase?void 0:$scope.$apply()},$scope.isEnabled=function(i,feedName){return $scope.settings[$scope.languageNames[i].toLowerCase()+"_feeds_enabled"].indexOf(feedName)>-1?!0:!1},$scope.switchEnabled=function(i,feedName){return $scope.settings[$scope.languageNames[i].toLowerCase()+"_feeds_enabled"].indexOf(feedName)>-1?$scope.settings[$scope.languageNames[i].toLowerCase()+"_feeds_enabled"].splice($scope.settings[$scope.languageNames[i].toLowerCase()+"_feeds_enabled"].indexOf(feedName),1):$scope.settings[$scope.languageNames[i].toLowerCase()+"_feeds_enabled"].push(feedName),$scope.news=!1,User.setSettings($scope.settings).then(function(){return User.getAuthKey().then(function(key){return key!==!1?User.saveServerSettings().then(function(){return fetchRepositories(!0)}):fetchRepositories(!0)})})},$scope.isOpen=function(id){return angular.isDefined($scope.openedArticles[id])&&$scope.openedArticles[id]===!0?!0:!1},$scope.openArticle=function(id){return angular.isUndefined($scope.openedArticles[id])||$scope.openedArticles[id]===!1&&$scope.justClosed!==!0?($scope.openedArticles[id]=!0,ScrollTo(id,70)):void 0},$scope.closeArticle=function(id){return angular.isDefined($scope.openedArticles[id])&&$scope.openedArticles[id]===!0&&($scope.openedArticles[id]=!1),$scope.justClosed=!0,setTimeout(function(){return $scope.justClosed=!1,$scope.$$phase?void 0:$scope.$apply()},30)},$scope.login=function(){var email,password;return $scope.loginError=!1,$scope.$$phase||$scope.$apply(),password=CryptoJS.SHA512($scope.password),email=$scope.email,$scope.loadingLogin=!0,$scope.rand=Math.floor(7*Math.random()+1),"Login"===$scope.loginBtnText?api.get("login?email="+email+"&password="+password).then(function(res){return User.setAuthKey(res.auth_key).then(function(){return User.getServerSettings().then(function(serverSet){return User.setSettings(serverSet).then(function(){return $scope.loadingLogin=!1,$window.location.reload(),$scope.$$phase?void 0:$scope.$apply()})}),$scope.userLoggedIn=!0})},function(errorMessage){return $scope.loginError=errorMessage,$scope.loadingLogin=!1,$scope.$$phase?void 0:$scope.$apply()}):api.get("register?email="+email+"&password="+password).then(function(res){return User.setAuthKey(res.auth_key).then(function(){return User.saveServerSettings().then(function(){return $window.location.reload()})})},function(errorMessage){return $scope.loginError=errorMessage,$scope.loadingLogin=!1,$scope.$$phase?void 0:$scope.$apply()})},$scope.loginStart=function(){var email,password;return $scope.loginError=!1,password=CryptoJS.SHA512($scope.password),email=$scope.email,$scope.loadingLogin=!0,$scope.rand=Math.floor(7*Math.random()+1),api.get("login?email="+email+"&password="+password).then(function(res){return User.setAuthKey(res.auth_key).then(function(){return User.getServerSettings().then(function(serverSet){return User.setSettings(serverSet).then(function(){return $scope.loadingLogin=!1,$window.location.reload(),$scope.$$phase?void 0:$scope.$apply()})}),$scope.userLoggedIn=!0})},function(errorMessage){return $scope.loadingLogin=!1,$scope.loginErrorStart=errorMessage,$scope.$$phase?void 0:$scope.$apply()})},$scope.syncSettings=function(){return User.getServerSettings().then(function(serverSet){return User.setSettings(serverSet).then(function(){return $window.location.reload()})})},$scope.setEmail=function(email){return $scope.email=email},$scope.setPassword=function(password){return $scope.password=password},$scope.switchLoginType=function(){return"Login"===$scope.loginBtnText?($scope.loginBtnText="Register",$scope.loginLabelText="login"):($scope.loginBtnText="Login",$scope.loginLabelText="register")},$scope.logout=function(){return User.destroy().then(function(){return $window.location.reload()})},$scope.loadMore=function(){return $scope.lastPage++,User.getAuthKey().then(function(key){return key!==!1?api.get("news?auth_key="+key+"&page="+$scope.lastPage).then(function(res){return prepareNews(res)}):User.getSettings().then(function(settings){return api.post({url:"news?page="+$scope.lastPage,data:$.param({settings:settings}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(res){return prepareNews(res)})})})},$scope.getRepoRows=function(){var array,i,tmpArray,_i,_len,_ref;if(_tmp_repo_rows!==!1)return _tmp_repo_rows;if(_.isUndefined($scope.repos))return[];for(array=[],tmpArray=[],_ref=$scope.repos,_i=0,_len=_ref.length;_len>_i;_i++)i=_ref[_i],tmpArray.length<=3?tmpArray.push(i):(array.push(tmpArray),tmpArray=[]);return _tmp_repo_rows=array,array},init()}),angular.module("genApp").controller("LanguagesCtrl",function($scope,$http,api,User,Initializer){var settings,_allLanguages;return settings={},_allLanguages=[],Initializer.init().then(function(){return User.getSettings().then(function(s){return settings=s,$scope.selectedLanguages=settings.languages_following,$scope.$$phase||$scope.$apply(),api.get("languages?with_feeds=true").then(function(res){var i,row,_i,_len;for(_allLanguages=res,$scope.languages=[],row=[],_i=0,_len=res.length;_len>_i;_i++)i=res[_i],row.length<6?row.push(i):($scope.languages.push(row),row=[]);return $scope.$$phase?void 0:$scope.$apply()})})}),$scope.click=function(lang){var index,l,_i,_len;if(index=settings.languages_following.indexOf(lang),-1!==index)settings.languages_following.splice(index,1);else for(settings.languages_following.push(lang),_i=0,_len=_allLanguages.length;_len>_i;_i++)if(l=_allLanguages[_i],l.name===lang&&(0===settings[lang.toLowerCase()+"_feeds_enabled"].length||settings.overwrite_feeds===!0))return settings[lang.toLowerCase()+"_feeds_enabled"]=l.feeds,User.setSettings(settings).then(function(){return User.getAuthKey().then(function(key){return key!==!1?User.saveServerSettings():void 0})}),!0;return User.setSettings(settings).then(function(){return User.getAuthKey().then(function(key){return key!==!1?User.saveServerSettings():void 0})})}}),angular.module("genApp").controller("SettingsCtrl",function($scope,$http,api,User,Initializer){var applySettings,editor,setHeight,setTextFirstTime,settings,_docs;return settings={},_docs={},$scope.isSaved=!0,Initializer.init().then(function(){return User.getSettings().then(function(s){return settings=s,applySettings(),editor.gotoLine(1,1)}),api.get("settings_docs").then(function(d){return _docs=d,$scope.docs=d,applySettings})}),editor={},editor=ace.edit("editor"),setHeight=function(){return $("#editor").height(Math.max($(document).height(),$(window).height())-70),$(".documentation").height(Math.max($(document).height(),$(window).height())-70)},setHeight(),window.addEventListener("resize",setHeight()),setTextFirstTime=!0,setTimeout(function(){return $scope.isSaved=!0,$scope.$$phase?void 0:$scope.$apply()},500),applySettings=function(){return editor.setTheme(settings.editor_theme),editor.setFontSize(settings.editor_font_size),editor.getSession().setMode("ace/mode/json"),editor.commands.addCommand({name:"saveCommand",bindKey:{win:settings.editor_save_windows,mac:settings.editor_save_mac},exec:function(editor){var e,settings_new;settings_new=editor.getValue();try{JSON.parse(settings_new)}catch(_error){return e=_error,!1}return settings=JSON.parse(settings_new),User.setSettings(settings).then(function(){return User.getAuthKey().then(function(res){return res!==!1?User.saveServerSettings():void 0}),applySettings(),$scope.isSaved=!0})}}),editor.on("change",function(){return $scope.isSaved=!1,$scope.$$phase?void 0:$scope.$apply()}),setTextFirstTime?(setTextFirstTime=!1,editor.setValue(JSON.stringify(settings,null,"	"))):void 0},$scope.setFilter=function(query){var i,name;$scope.docs={};for(i in _docs)name=_docs[i],i.indexOf(query)>-1&&($scope.docs[i]=name);return $scope.$$phase?void 0:$scope.$apply()}}),angular.module("genApp").service("User",function($q,api){var db,getUserObject,is_initialized,obj,_default_cache;return obj={},db=new PouchDB("geek_challange_user_11315g3426123"),_default_cache=!1,is_initialized=!1,obj.destroy=function(){var deferred;return deferred=new $q.defer,db.destroy().then(function(){return deferred.resolve(!0)}),deferred.promise},getUserObject=function(){var deferred;return deferred=new $q.defer,db.get("user").then(function(doc){return _.isUndefined(doc.auth_key)?db.put({_id:"user",auth_key:!1,settings:!1}).then(function(doc){return deferred.resolve(doc)}):deferred.resolve(doc)},function(err){return err?db.put({_id:"user",auth_key:!1,settings:!1}).then(function(doc2){return deferred.resolve(doc2)}):void 0}),deferred.promise},obj.getAuthKey=function(){var deferred;return deferred=new $q.defer,getUserObject().then(function(doc){return _.isUndefined(doc.auth_key)&&(doc.auth_key=!1),deferred.resolve(doc.auth_key)}),deferred.promise},obj.setAuthKey=function(key){var deferred;return deferred=new $q.defer,getUserObject().then(function(doc){return db.put({_id:"user",_rev:doc._rev,auth_key:key,settings:doc.settings}).then(function(){return deferred.resolve(!0)})}),deferred.promise},obj.getSettings=function(){var deferred;return deferred=new $q.defer,getUserObject().then(function(doc){return deferred.resolve(doc.settings)}),deferred.promise},obj.setSettings=function(settings){var deferred,e,newSettings;newSettings={};try{newSettings=JSON.parse(settings)}catch(_error){e=_error,newSettings=settings}return settings=newSettings,deferred=new $q.defer,getUserObject().then(function(doc){return db.put({_id:"user",_rev:doc._rev,settings:settings,auth_key:doc.auth_key}).then(function(){return deferred.resolve(!0)})}),deferred.promise},obj.getDefaultSettings=function(){var deferred;return deferred=new $q.defer,_default_cache!==!1?deferred.resolve(_default_cache):api.get("settings_default").then(function(settings){return _default_cache=settings,deferred.resolve(_default_cache)}),deferred.promise},obj.getServerSettings=function(){var deferred;return deferred=new $q.defer,obj.getAuthKey().then(function(auth_key){return auth_key===!1&&deferred.resolve(!1),api.get({url:"settings?auth_key="+auth_key}).then(function(res){var e,settings;settings={};try{settings=JSON.parse(res)}catch(_error){e=_error,settings=res}return deferred.resolve(settings)})}),deferred.promise},obj.saveServerSettings=function(){var deferred;return deferred=new $q.defer,obj.getAuthKey().then(function(auth_key){return auth_key===!1&&deferred.resolve(!1),obj.getSettings().then(function(settings){return api.post({url:"save_settings?auth_key="+auth_key,data:$.param({settings:JSON.stringify(settings)}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(){return deferred.resolve(!0)})})}),deferred.promise},obj.valSetting=function(attribute,settings){return settings.indexOf(attribute)>-1?settings[attribute]:_default_cache[attribute]},obj}),angular.module("ngScrollTo",[]),angular.module("ngScrollTo").directive("scrollTo",["ScrollTo",function(ScrollTo){return{restrict:"AC",compile:function(){return function(scope,element,attr){element.bind("click",function(){ScrollTo.idOrName(attr.scrollTo,attr.offset)})}}}}]),angular.module("ngScrollTo").service("ScrollTo",["$window",function($window){return this.idOrName=function(idOrName,offset){var document,el,top;document=$window.document,idOrName||$window.scrollTo(0,0),el=document.getElementById(idOrName),el||(el=document.getElementsByName(idOrName),el=el&&el.length?el[0]:null),el&&(offset?(top=$(el).offset().top-offset,window.scrollTo(0,top)):el.scrollIntoView())}}]),angular.module("genApp").controller("ResetCtrl",function(User,$window,$location){return User.destroy().then(function(){return setTimeout(function(){return $window.location.reload()},500),$location.path("/")})}),angular.module("genApp").controller("MenuCtrl",function($location,$scope){return $scope.setAll=function(){return $scope.classLang="",$scope.classSettings="",$scope.classFaq=""},$scope.setActive=function(){return"/languages"===$location.path()&&($scope.setAll(),$scope.classLang="active"),"/settings"===$location.path()&&($scope.setAll(),$scope.classSettings="active"),"/faq"===$location.path()?($scope.setAll(),$scope.classFaq="active"):void 0},$scope.$on("$routeChangeStart",function(){return $scope.setActive()}),$scope.setActive()});